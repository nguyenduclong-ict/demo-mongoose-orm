(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{799:function(e,t,n){"use strict";var r=n(22);n.d(t,"a",(function(){return r}));var o=n(114);n.d(t,"b",(function(){return o}))},833:function(e,t,n){"use strict";n(21);t.a={computed:{title:function(){var e;return(null===(e=this.$route.meta)||void 0===e?void 0:e.title)||this.$route.name}},created:function(){var e={title:this.title};this.$store.commit("SET_PAGE",e)}}},849:function(e,t,n){var content=n(873);content.__esModule&&(content=content.default),"string"==typeof content&&(content=[[e.i,content,""]]),content.locals&&(e.exports=content.locals);(0,n(33).default)("c7f73d48",content,!0,{sourceMap:!1})},872:function(e,t,n){"use strict";n(849)},873:function(e,t,n){var r=n(32)(!1);r.push([e.i,".permission-page .page-item{margin-right:0;display:flex}.permission-page .page-item .el-checkbox__input{margin-top:4px}",""]),e.exports=r},886:function(e,t,n){"use strict";n.r(t);n(12),n(38),n(39);var r=n(295),o=n(7),c=n(8),l=(n(63),n(199),n(13),n(20),n(25),n(21),n(113),n(119),n(81),n(116),n(31)),m=n(306),f=n(799),d=n(22),h=n(833),y=n(114);function v(object,e){var t=Object.keys(object);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(object);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(object,e).enumerable}))),t.push.apply(t,n)}return t}var P=["read","create","update","delete"],O={mixins:[h.a],asyncData:function(e){return Object(c.a)(regeneratorRuntime.mark((function t(){var n,r,o,c,l,f,h,v,O,x,_,j,k,w;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.$api,r=e.$axios,o=e.params,c=e.store,l=e.error,f=c.state.schemas,O={},"authenticated"!==o.code){t.next=10;break}return v={code:"authenticated",name:"Người dùng đã đăng nhập"},t.next=7,n.Permission.find({query:{isAuthenticated:!0}});case 7:h=t.sent,t.next=25;break;case 10:if("anonymous"!==o.code){t.next=17;break}return v={code:"anonymous",name:"Người dùng chưa đăng nhập"},t.next=14,n.Permission.find({query:{isAnonymous:!0}});case 14:h=t.sent,t.next=25;break;case 17:return t.next=19,n.Role.findOne({query:{code:o.code}});case 19:if(v=t.sent){t.next=22;break}return t.abrupt("return",l({statusCode:404,message:"Không tìm thấy vai trò"}));case 22:return t.next=24,n.Permission.find({query:{role:Object(y.getObjectId)(v)}});case 24:h=t.sent;case 25:return Object.keys(f).forEach((function(e){O[e]=Object(d.cloneDeep)(f[e]),O[e].permissions=h.filter((function(t){return"entity"===t.entityType&&t.entity===e}))})),t.next=28,r.$get("/admin/apis");case 28:return x=t.sent,_={},j=[],x.forEach((function(e){_[e.group]=_[e.group]||[],_[e.group].push(e);var t=h.find((function(t){return"api"===t.entityType&&t.path===e.endpoint&&t.method===e.method}));t&&j.push(t)})),k=[],function e(t,n){return t.forEach((function(t){n.push(t),t.children&&t.children.length&&e(t.children,n)})),n}(m.routes,k),w=h.filter((function(e){return"admin-page"===e.entityType})),t.abrupt("return",{entities:O,role:v,allActions:P,serverApis:x,apis:_,pages:k,apiPermissions:j,pagePermissions:w});case 37:case"end":return t.stop()}}),t)})))()},computed:function(e){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?v(Object(source),!0).forEach((function(t){Object(o.a)(e,t,source[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(source)):v(Object(source)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(source,t))}))}return e}({title:function(){return"Phân quyền cho <strong>".concat(this.role.name,"</strong>")}},Object(l.c)(["schemas"])),methods:{getTagType:function(e){return{create:"primary",read:"info",update:"success",delete:"danger"}[e]},isIndeterminateEntity:function(e){return!!e.permissions.find((function(e){return e.status}))&&!this.isAllEntityPermission(e)},isAllEntityPermission:function(e){return P.every((function(t){return!!e.permissions.find((function(e){return e.action===t&&e.status}))}))},isHasEntityPermission:function(e,t){return!!e.permissions.find((function(e){return e.action===t&&e.status}))},changeEntityPermission:function(e,t,n){var r=e.permissions.find((function(e){return e.action===t}));r?r.status=n:e.permissions.push({entityType:"entity",role:Object(y.getObjectId)(this.role),entity:e.key,status:n,action:t,isAnonymous:"anonymous"===this.role.code,isAuthenticated:"authenticated"===this.role.code})},checkAllEntityPermission:function(e,t){var n=this;t?P.forEach((function(t){var r=e.permissions.find((function(e){return e.action===t}));r?r.status=!0:e.permissions.push({entityType:"entity",role:Object(y.getObjectId)(n.role),entity:e.key,status:!0,action:t,isAnonymous:"anonymous"===n.role.code,isAuthenticated:"authenticated"===n.role.code})})):e.permissions.forEach((function(p){return p.status=!1}))},handleSave:function(){var e=this;return Object(c.a)(regeneratorRuntime.mark((function t(){var n,o;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,n=[].concat(Object(r.a)(e.pagePermissions),Object(r.a)(e.apiPermissions)),Object.keys(e.entities).forEach((function(t){e.entities[t].permissions.forEach((function(p){n.push(p)}))})),t.next=5,e.$axios.$put("/admin/update-permission",{permissions:n});case 5:o=t.sent,console.log(o),e.$message.success("Cập nhật thành công"),setTimeout((function(){e.$router.go()}),200),t.next=15;break;case 11:t.prev=11,t.t0=t.catch(0),console.error(t.t0),e.$message.error("Có lỗi xảy ra");case 15:case"end":return t.stop()}}),t,null,[[0,11]])})))()},handleChangeOnlySelf:function(e,t,n){var r=e.permissions.find((function(e){return e.action===t}));r&&(r.onlySelf=n,f.b.replace(e.permissions,r,(function(e){return e===r})))},isOnlySelf:function(e,t){return!!e.permissions.find((function(e){return e.action===t&&e.onlySelf}))},changeApiPermission:function(e,t){console.log("changeApiPermission",e,t);var n=this.apiPermissions.find((function(p){return p.method===e.method&&p.endpoint===e.path}));n?n.status=t:this.apiPermissions.push({entityType:"api",role:Object(y.getObjectId)(this.role),status:t,isAnonymous:"anonymous"===this.role.code,isAuthenticated:"authenticated"===this.role.code,endpoint:e.path,method:e.method})},isHasApiPermission:function(e){return!!this.apiPermissions.find((function(p){return p.method===e.method&&p.endpoint===e.path&&p.status}))},changePagePermission:function(e,t){console.log("changePagePermission",e,t);var n=this.pagePermissions.find((function(p){return p.pageName===e.name}));n?n.status=t:this.pagePermissions.push({entityType:"admin-page",role:Object(y.getObjectId)(this.role),status:t,isAnonymous:"anonymous"===this.role.code,isAuthenticated:"authenticated"===this.role.code,pageName:e.name})},isHasPagePermission:function(e){return!!this.pagePermissions.find((function(p){return p.pageName===e.name&&p.status}))}}},x=(n(872),n(4)),component=Object(x.a)(O,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"permission-page"},[n("div",{staticClass:"flex justify-end mb-2"},[n("el-button",{attrs:{template:"save"},on:{click:e.handleSave}})],1),e._v(" "),n("el-tabs",{attrs:{type:"border-card",value:"entity"}},[n("el-tab-pane",{attrs:{label:"Entity",name:"entity"}},[n("el-collapse",e._l(e.entities,(function(t){return n("el-collapse-item",{key:t.key,attrs:{name:t.key}},[n("template",{slot:"title"},[e._v("\n            "+e._s(t.name)+"\n            "),e._l(t.permissions,(function(p){return[p.status?n("el-tag",{key:p.action,staticClass:"ml-2",attrs:{type:e.getTagType(p.action),size:"mini"}},[e._v("\n                "+e._s(p.action)+"\n              ")]):e._e()]}))],2),e._v(" "),n("div",[n("el-checkbox",{attrs:{value:e.isAllEntityPermission(t),indeterminate:e.isIndeterminateEntity(t)},on:{change:function(n){return e.checkAllEntityPermission(t,n)}}},[e._v("\n              All\n            ")])],1),e._v(" "),n("div",e._l(e.allActions,(function(r){return n("div",{key:r,staticClass:"inline-flex items-center px-4 first:pl-0 border-r last:border-r-0"},[n("el-checkbox",{attrs:{value:e.isHasEntityPermission(t,r)},on:{change:function(n){return e.changeEntityPermission(t,r,n)}}},[e._v("\n                "+e._s(r)+"\n              ")]),e._v(" "),e.isHasEntityPermission(t,r)?n("el-switch",{staticClass:"ml-2",attrs:{"active-text":"Only Self",value:e.isOnlySelf(t,r)},on:{change:function(n){return e.handleChangeOnlySelf(t,r,n)}}}):e._e()],1)})),0)],2)})),1)],1),e._v(" "),n("el-tab-pane",{attrs:{label:"Api",name:"api"}},[n("el-collapse",e._l(e.apis,(function(t,r){return n("el-collapse-item",{key:r,attrs:{title:r}},[n("div",{staticClass:"flex flex-wrap"},e._l(t,(function(t){return n("el-checkbox",{key:t.method+" "+t.path,staticClass:"w-full sm:w-1/2 md:w-1/3 lg:w-1/4",staticStyle:{"margin-right":"0"},attrs:{label:t.method+" "+t.path,value:e.isHasApiPermission(t)},on:{change:function(n){return e.changeApiPermission(t,n)}}})})),1)])})),1)],1),e._v(" "),n("el-tab-pane",{attrs:{label:"Page",name:"page"}},[n("div",{staticClass:"flex flex-wrap"},e._l(e.pages,(function(t){return n("div",{key:t.name,staticClass:"w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-2"},[n("el-checkbox",{staticClass:"border rounded page-item p-2",staticStyle:{"margin-right":"0"},attrs:{value:e.isHasPagePermission(t)},on:{change:function(n){return e.changePagePermission(t,n)}}},[n("div",[e._v("\n              "+e._s(t.name)+"\n            ")]),e._v(" "),n("div",{staticClass:"text-xs italic"},[e._v("\n              "+e._s(e._.get(t,"meta.title"))+"\n            ")])])],1)})),0)])],1)],1)}),[],!1,null,null,null);t.default=component.exports}}]);